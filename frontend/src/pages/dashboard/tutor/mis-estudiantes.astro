---
import DashboardLayout from "@layouts/DashboardLayout.astro";
import RequestEnrollmentSideOver from "@components/dashboard/tutor/RequestEnrollmentSideOver.astro";
import RegisterStudentSideOver from "@components/dashboard/tutor/RegisterStudentSideOver.astro";
import TutorHeader from "@components/dashboard/tutor/TutorHeader.astro";
import StudentCard from "@components/dashboard/tutor/StudentCard.astro";
import EmptyState from "@components/dashboard/tutor/EmptyState.astro";
import ErrorBanner from "@components/dashboard/tutor/ErrorBanner.astro";
import { isTutor, getTutorPageData } from "@lib/utils/tutor";
import type { Student } from "@lib/types/student";
import type { Enrollment } from "@lib/types/enrollment";

const { user, token } = Astro.locals;

// Redirigir si no es tutor
if (!user || !isTutor(user)) {
  return Astro.redirect(
    "/dashboard?error=No tienes permisos para acceder a esta sección",
  );
}

const tutorId = user.profile?.documentId;
const {
  tutorData,
  degrees,
  academicPeriods,
  enrollmentData,
  error: fetchError,
} = await getTutorPageData(token as string, tutorId);

const apiError = tutorData?.error;
const displayError = fetchError || apiError;
const students: Student[] = tutorData?.data?.students || [];
const enrollmentsList: Enrollment[] = enrollmentData || [];

const pageTitle = "Mis Estudiantes";
---

<DashboardLayout pageTitle={pageTitle}>
  <div class="animate-fade-in space-y-8">
    <TutorHeader
      title="Mis Estudiantes"
      description="Aquí puedes ver la información de tus hijos registrados"
      showSecondaryButton={true}
      secondaryButtonText="Registrar Nuevo Hijo"
      secondaryButtonId="register-student-btn"
      showActionButton={true}
      actionButtonText="Solicitar Matrícula"
      actionButtonId="request-enrollment-btn"
    />

    {displayError && <ErrorBanner message={displayError} />}

    {!displayError && students.length === 0 && <EmptyState />}

    {
      !displayError && students.length > 0 && (
        <div class="grid grid-cols-1 gap-6 md:grid-cols-2 lg:grid-cols-3">
          {students.map((student) => (
            <StudentCard student={student} enrollmentsList={enrollmentsList} />
          ))}
        </div>
      )
    }
  </div>

  <RequestEnrollmentSideOver
    students={students}
    enrollmentsList={enrollmentsList}
    degrees={degrees}
    academicPeriods={academicPeriods}
    tutorProfileId={user.profile?.documentId || ""}
  />

  <RegisterStudentSideOver tutorProfileId={user.profile?.documentId || ""} />
</DashboardLayout>

<style>
  .animate-fade-in {
    animation: fadeIn 0.6s ease-out forwards;
  }

  @keyframes fadeIn {
    from {
      opacity: 0;
      transform: translateY(10px);
    }
    to {
      opacity: 1;
      transform: translateY(0);
    }
  }
</style>

<script>
  document
    .getElementById("request-enrollment-btn")
    ?.addEventListener("click", () => {
      const dialog = document.getElementById(
        "tutor-enrollment-sideover",
      ) as HTMLDialogElement;
      dialog?.showModal();
    });

  document
    .getElementById("register-student-btn")
    ?.addEventListener("click", () => {
      const dialog = document.getElementById(
        "register-student-sideover",
      ) as HTMLDialogElement;
      dialog?.showModal();
    });
</script>
