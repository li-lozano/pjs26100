---
import DashboardLayout from "@layouts/DashboardLayout.astro";
import ReadStudents from "@lib/services/private/ReadStudents";
import CreateStudent from "@lib/services/private/CreateStudent";
import type { Student } from "@lib/types/student";
import StudentsHeader from "@components/dashboard/estudiantes/StudentsHeader.astro";
import StudentsFilters from "@components/dashboard/estudiantes/StudentsFilters.astro";
import StudentsTable from "@components/dashboard/estudiantes/StudentsTable.astro";
import CreateStudentSideOver from "@components/dashboard/estudiantes/CreateStudentSideOver.astro";
import MessageError from "@components/MessageError.astro";
import MessageSuccess from "@components/MessageSuccess.astro";

const { user, token } = Astro.locals;
let students: Student[] = [];
let error = "";
let success = "";

// Manejo del formulario de creaci√≥n
if (Astro.request.method === "POST") {
  try {
    const formData = await Astro.request.formData();
    const studentData = {
      names: formData.get("names") as string,
      surnames: formData.get("surnames") as string,
      dni: formData.get("dni") as string,
      birthday: formData.get("birthday") as string,
    };

    await CreateStudent(token as string, studentData);
    success = "Estudiante registrado exitosamente";
  } catch (e) {
    error = e instanceof Error ? e.message : "Error al registrar el estudiante";
  }
}

// Cargar estudiantes
try {
  if (token) {
    students = await ReadStudents(token);
  }
} catch (e) {
  console.error("Error loading students:", e);
  error = "No se pudieron cargar los estudiantes.";
}

const pageTitle = "Estudiantes";
---

<DashboardLayout pageTitle={pageTitle}>
  <div class="space-y-8 animate-fade-in">
    <StudentsHeader sideOverId="student-sideover" />

    {error && <MessageError message={error} />}
    {success && <MessageSuccess message={success} />}

    <StudentsFilters />
    <StudentsTable students={students} error={error} />
  </div>

  <CreateStudentSideOver />
</DashboardLayout>

<style>
  .animate-fade-in {
    animation: fadeIn 0.6s ease-out forwards;
  }

  @keyframes fadeIn {
    from {
      opacity: 0;
      transform: translateY(10px);
    }
    to {
      opacity: 1;
      transform: translateY(0);
    }
  }

  /* Custom scrollbar for table */
  .overflow-x-auto::-webkit-scrollbar {
    height: 6px;
  }
  .overflow-x-auto::-webkit-scrollbar-track {
    background: transparent;
  }
  .overflow-x-auto::-webkit-scrollbar-thumb {
    background: #e5e7eb;
    border-radius: 10px;
  }
  .overflow-x-auto::-webkit-scrollbar-thumb:hover {
    background: #d1d5db;
  }
</style>
