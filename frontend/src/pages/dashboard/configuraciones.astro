---
import DashboardLayout from "@layouts/DashboardLayout.astro";
import ReadAcademicPeriods from "@lib/services/private/ReadAcademicPeriods";
import ReadDegrees from "@lib/services/private/ReadDegrees";
import CreateDegree from "@lib/services/private/CreateDegree";
import ConfigHeader from "@components/dashboard/configuraciones/ConfigHeader.astro";
import ConfigTabs from "@components/dashboard/configuraciones/ConfigTabs.astro";
import AcademicPeriodsTable from "@components/dashboard/configuraciones/AcademicPeriodsTable.astro";
import DegreesTable from "@components/dashboard/configuraciones/DegreesTable.astro";
import CreateAcademicPeriodSideOver from "@components/dashboard/configuraciones/CreateAcademicPeriodSideOver.astro";
import UpdateAcademicPeriodSideOver from "@components/dashboard/configuraciones/UpdateAcademicPeriodSideOver.astro";
import CreateDegreeSideOver from "@components/dashboard/configuraciones/CreateDegreeSideOver.astro";
import UpdateDegreeSideOver from "@components/dashboard/configuraciones/UpdateDegreeSideOver.astro";
import MessageError from "@components/MessageError.astro";
import MessageSuccess from "@components/MessageSuccess.astro";
import type { AcademicPeriod } from "@lib/types/academic_period";
import type { Degree } from "@lib/types/degree";

const { user, token } = Astro.locals;

// Redirigir si no tiene permiso (Solo administradores)
const allowedRoles = ["Administrador"];
if (!user || !allowedRoles.includes(user.role?.name || "")) {
  return Astro.redirect(
    "/dashboard?error=No tienes permisos para acceder a las configuraciones del sistema",
  );
}

// Obtener pestaña activa de la URL
const url = new URL(Astro.request.url);
const activeTab = url.searchParams.get("tab") || "periodos";

let periods: AcademicPeriod[] = [];
let degrees: Degree[] = [];
let error = url.searchParams.get("error") || "";
let success = url.searchParams.get("success") || "";

// Cargar datos según la pestaña activa

// Cargar datos según la pestaña activa
try {
  if (activeTab === "periodos") {
    periods = await ReadAcademicPeriods(token as string);
  } else if (activeTab === "grados") {
    degrees = await ReadDegrees(token as string);
  }
} catch (e) {
  error = "Error al cargar los datos de configuración";
}
---

<DashboardLayout pageTitle="Configuraciones del Sistema">
  <div
    class="animate-in fade-in slide-in-from-bottom-4 mx-auto max-w-7xl space-y-8 duration-500"
  >
    <div class="flex flex-col gap-6">
      {error && <MessageError message={error} />}
      {success && <MessageSuccess message={success} />}
      <ConfigTabs activeTab={activeTab} />
      <div
        class="shadow-rayito-blue/5 rounded-[2.5rem] border border-white bg-white/60 p-8 shadow-2xl backdrop-blur-xl"
      >
        {
          activeTab === "periodos" && (
            <div class="space-y-6">
              <ConfigHeader
                title="Periodos Académicos"
                subtitle="Gestiona los ciclos lectivos para nuevos procesos de matrícula."
                buttonText="Nuevo Periodo"
                sideOverId="academic-period-sideover"
              />
              <AcademicPeriodsTable periods={periods} />
            </div>
          )
        }

        {
          activeTab === "grados" && (
            <div class="space-y-6">
              <ConfigHeader
                title="Grados y Secciones"
                subtitle="Define los niveles educativos y las secciones disponibles."
                buttonText="Agregar Grado"
                sideOverId="degree-sideover"
              />
              <DegreesTable degrees={degrees} />
            </div>
          )
        }
      </div>
    </div>
  </div>
  <CreateAcademicPeriodSideOver />
  <UpdateAcademicPeriodSideOver />
  <CreateDegreeSideOver />
  <UpdateDegreeSideOver />
</DashboardLayout>
