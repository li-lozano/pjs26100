---
import DashboardLayout from "@layouts/DashboardLayout.astro";
import ReadAcademicPeriods from "@lib/services/private/ReadAcademicPeriods";
import ReadDegrees from "@lib/services/private/ReadDegrees";
import CreateAcademicPeriod from "@lib/services/private/CreateAcademicPeriod";
import CreateDegree from "@lib/services/private/CreateDegree";
import ConfigHeader from "@components/dashboard/configuraciones/ConfigHeader.astro";
import ConfigTabs from "@components/dashboard/configuraciones/ConfigTabs.astro";
import AcademicPeriodsTable from "@components/dashboard/configuraciones/AcademicPeriodsTable.astro";
import DegreesTable from "@components/dashboard/configuraciones/DegreesTable.astro";
import CreateAcademicPeriodSideOver from "@components/dashboard/configuraciones/CreateAcademicPeriodSideOver.astro";
import CreateDegreeSideOver from "@components/dashboard/configuraciones/CreateDegreeSideOver.astro";
import MessageError from "@components/MessageError.astro";
import MessageSuccess from "@components/MessageSuccess.astro";
import type { AcademicPeriod, Degree } from "@lib/types/enrollment";

const { user, token } = Astro.locals;

// Redirigir si no tiene permiso (Solo administradores)
const allowedRoles = ["Administrador"];
if (!user || !allowedRoles.includes(user.role?.name || "")) {
  return Astro.redirect(
    "/dashboard?error=No tienes permisos para acceder a las configuraciones del sistema",
  );
}

// Obtener pestaña activa de la URL
const url = new URL(Astro.request.url);
const activeTab = url.searchParams.get("tab") || "periodos";

let periods: AcademicPeriod[] = [];
let degrees: Degree[] = [];
let error = "";
let success = "";

// Manejo de formularios (POST)
if (Astro.request.method === "POST") {
  try {
    const formData = await Astro.request.formData();
    const action = formData.get("action");

    if (action === "create-period") {
      const data = {
        name: formData.get("name") as string,
        active: formData.get("active") === "on",
      };
      await CreateAcademicPeriod(token as string, data);
      success = "Periodo académico creado correctamente";
    } else if (action === "create-degree") {
      const data = {
        name: formData.get("name") as string,
        section: formData.get("section") as string,
        capacity: Number(formData.get("capacity")),
      };
      await CreateDegree(token as string, data);
      success = "Grado y sección creados correctamente";
    }
  } catch (e) {
    error = e instanceof Error ? e.message : "Error al procesar la solicitud";
  }
}

// Cargar datos según la pestaña activa
try {
  if (activeTab === "periodos") {
    periods = await ReadAcademicPeriods(token as string);
  } else if (activeTab === "grados") {
    degrees = await ReadDegrees(token as string);
  }
} catch (e) {
  error = "Error al cargar los datos de configuración";
}
---

<DashboardLayout pageTitle="Configuraciones del Sistema">
  <div
    class="max-w-7xl mx-auto space-y-8 animate-in fade-in slide-in-from-bottom-4 duration-500"
  >
    <div class="flex flex-col gap-6">
      <ConfigTabs activeTab={activeTab} />

      <div
        class="bg-white/60 backdrop-blur-xl rounded-[2.5rem] p-8 border border-white shadow-2xl shadow-rayito-blue/5"
      >
        {
          activeTab === "periodos" && (
            <div class="space-y-6">
              <ConfigHeader
                title="Periodos Académicos"
                subtitle="Gestiona los ciclos lectivos para nuevos procesos de matrícula."
                buttonText="Nuevo Periodo"
                sideOverId="academic-period-sideover"
              />

              {error && <MessageError message={error} />}
              {success && <MessageSuccess message={success} />}

              <AcademicPeriodsTable periods={periods} />
            </div>
          )
        }

        {
          activeTab === "grados" && (
            <div class="space-y-6">
              <ConfigHeader
                title="Grados y Secciones"
                subtitle="Define los niveles educativos y las secciones disponibles."
                buttonText="Agregar Grado"
                sideOverId="degree-sideover"
              />

              {error && <MessageError message={error} />}
              {success && <MessageSuccess message={success} />}

              <DegreesTable degrees={degrees} />
            </div>
          )
        }
      </div>
    </div>
  </div>

  <CreateAcademicPeriodSideOver />
  <CreateDegreeSideOver />
</DashboardLayout>
