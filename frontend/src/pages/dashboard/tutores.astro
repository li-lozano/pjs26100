---
import DashboardLayout from "@layouts/DashboardLayout.astro";
import ReadTutors from "@lib/services/private/ReadTutors";
import CreateTutor from "@lib/services/private/CreateTutor";
import CreateTutorModal from "@components/dashboard/tutores/CreateTutorModal.astro";
import TutorsHeader from "@components/dashboard/tutores/TutorsHeader.astro";
import TutorsTable from "@components/dashboard/tutores/TutorsTable.astro";
import MessageError from "@components/MessageError.astro";
import MessageSuccess from "@components/MessageSuccess.astro";
import type { User } from "@lib/types/user";

const { user, token } = Astro.locals;

// Redirigir si no tiene permiso
const allowedRoles = ["Administrador", "Encargado"];
if (!user || !allowedRoles.includes(user.role?.name || "")) {
  return Astro.redirect(
    "/dashboard?error=No tienes permisos para acceder a esta sección",
  );
}

let tutors: User[] = [];
let error = "";
let success = "";

// Manejo del formulario de creación
if (Astro.request.method === "POST") {
  try {
    const formData = await Astro.request.formData();
    const tutorData = {
      username: formData.get("username") as string,
      email: formData.get("email") as string,
      names: formData.get("names") as string,
      surnames: formData.get("surnames") as string,
      dni: formData.get("dni") as string,
      cell_phone: formData.get("cell_phone") as string,
    };

    await CreateTutor(token as string, tutorData);
    success = "Tutor registrado exitosamente";
  } catch (e) {
    error = e instanceof Error ? e.message : "Error al registrar el tutor";
  }
}

// Cargar tutores
try {
  tutors = await ReadTutors(token as string);
} catch (e) {
  error = "Error al cargar la lista de tutores";
}
---

<DashboardLayout pageTitle="Gestión de Tutores">
  <div class="space-y-6">
    <TutorsHeader modalId="tutor-modal" />

    {error && <MessageError message={error} />}
    {success && <MessageSuccess message={success} />}

    <TutorsTable tutors={tutors} />
  </div>

  <CreateTutorModal />
</DashboardLayout>
