---
import DashboardLayout from "@layouts/DashboardLayout.astro";
import ReadTutors from "@lib/services/private/ReadTutors";
import CreateTutorSideOver from "@components/dashboard/tutores/CreateTutorSideOver.astro";
import CreateStudentFromTutorSideOver from "@components/dashboard/estudiantes/CreateStudentFromTutorSideOver.astro";
import TutorsHeader from "@components/dashboard/tutores/TutorsHeader.astro";
import TutorsTable from "@components/dashboard/tutores/TutorsTable.astro";
import MessageError from "@components/MessageError.astro";
import MessageSuccess from "@components/MessageSuccess.astro";
import type { User } from "@lib/types/user";

const { user, token } = Astro.locals;

// Redirigir si no tiene permiso
const allowedRoles = ["Administrador", "Encargado"];
if (!user || !allowedRoles.includes(user.role?.name || "")) {
  return Astro.redirect(
    "/dashboard?error=No tienes permisos para acceder a esta sección",
  );
}

const url = new URL(Astro.request.url);
let error = url.searchParams.get("error") || "";
let success = url.searchParams.get("success") || "";
let tutors: User[] = [];

// Cargar tutores
try {
  tutors = await ReadTutors(token as string);
} catch (e) {
  error = "Error al cargar la lista de tutores";
}
---

<DashboardLayout pageTitle="Gestión de Tutores">
  <div class="space-y-6">
    <TutorsHeader sideOverId="tutor-sideover" />
    <TutorsTable tutors={tutors} />
  </div>

  <CreateTutorSideOver />
  <CreateStudentFromTutorSideOver />
</DashboardLayout>
